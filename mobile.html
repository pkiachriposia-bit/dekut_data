<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DeKUT Mobile GIS Navigation</title>

<!-- PWA LINKS -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0078ff">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial, sans-serif; background:#f2f2f2; }
#frontPage, #mapContainer {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background:#fff; display:flex; align-items:center; justify-content:center;
  flex-direction:column; z-index:9999;
}
#frontPage h1 { margin-bottom:20px; }
#accuracyDisplay { margin-bottom:20px; font-size:16px; }
#frontPage button {
  padding:10px 20px; font-size:16px; border:none;
  background:#0078ff; color:#fff; border-radius:5px; cursor:pointer;
}
#panel{ padding:10px; background:#fff; display:flex; gap:6px; flex-wrap:wrap;}
#panel input{ flex:1; padding:8px;}
#panel button{
  padding:8px 12px; border:none; background:#0078ff;
  color:#fff; border-radius:4px; cursor:pointer;
}
#infoBoxes{ display:flex; gap:6px; padding:10px;}
.infoBox{
  background:#fff; padding:8px; border-radius:4px;
  flex:1; font-size:14px; text-align:center;
}
#message{ padding:6px; font-weight:bold; }
#map{ height:80vh; }
</style>
</head>

<body>

<!-- FRONT PAGE -->
<div id="frontPage">
  <h1>DeKUT Navigation Prototype</h1>
  <p>Check GPS accuracy before starting navigation:</p>
  <div id="accuracyDisplay">Waiting for location...</div>
  <button id="okBtn" disabled onclick="startNavigation()">Start Navigation</button>
</div>

<!-- MAP AND PANEL -->
<div id="mapContainer" style="display:none;">
  <div id="panel">
    <input type="text" id="searchBox" placeholder="Search destination">
    <button onclick="searchFeature()">Search</button>
    <button onclick="locateUser()">My Location</button>
  </div>

  <div id="infoBoxes">
    <div class="infoBox" id="latBox">Lat: --</div>
    <div class="infoBox" id="lngBox">Lng: --</div>
    <div class="infoBox" id="distBox">Distance: -- m</div>
    <div class="infoBox" id="dirBox">Direction: --</div>
    <div class="infoBox" id="turnBox">Next: --</div>
  </div>

  <div id="message"></div>
  <div id="map"></div>
</div>

<!-- JS LIBRARIES -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ---------------- FRONT PAGE WITH ACCURACY ----------------
let accuracy, locationWatcher;

function waitForAccuracy(){
  if(!navigator.geolocation){
    document.getElementById('accuracyDisplay').textContent="Geolocation not supported!";
    return;
  }

  locationWatcher = navigator.geolocation.watchPosition(
    position => {
      accuracy = position.coords.accuracy;
      document.getElementById('accuracyDisplay').textContent =
        `Current accuracy: ${accuracy.toFixed(1)} m`;
      document.getElementById('okBtn').disabled = false;
    },
    err => {
      document.getElementById('accuracyDisplay').textContent =
        "Unable to get location: " + err.message;
    },
    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
  );
}
waitForAccuracy();

// ---------------- START NAVIGATION ----------------
function startNavigation(){
  if(accuracy > 20){
    const confirmContinue = confirm(
      `Warning: GPS accuracy is low (${accuracy.toFixed(1)} m). Do you want to continue?`
    );
    if(!confirmContinue) return;
  }

  document.getElementById('frontPage').style.display='none';
  document.getElementById('mapContainer').style.display='block';
  if(locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
  initializeMap();
}

// ---------------- MAP ----------------
let map, userMarker, destinationMarker, routeLine;
let boundaryLayer, roadsLayer, mainRoadsLayer;
let buildingLayer, pitchLayer;

function initializeMap(){
  map = L.map('map').setView([-0.3976, 36.9586], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:20
  }).addTo(map);

  loadData();
  locateUser();
}

// ---------------- LOCAL GEOJSON PATHS ----------------
const boundaryURL  = "boundary.geojson";
const buildingsURL = "building.geojson";
const mainRoadsURL = "main_roads.geojson";
const pitchURL     = "pitch.geojson";
const roadsURL     = "roads.geojson";

// ---------------- LOAD DATA ----------------
function loadData(){
  fetch(boundaryURL).then(r=>r.json()).then(data=>{
    boundaryLayer = L.geoJSON(data,{style:{color:"green",weight:2,fillOpacity:0}}).addTo(map);
  });
  fetch(roadsURL).then(r=>r.json()).then(data=>{
    roadsLayer = L.geoJSON(data,{style:{color:"#666",weight:2}}).addTo(map);
  });
  fetch(mainRoadsURL).then(r=>r.json()).then(data=>{
    mainRoadsLayer = L.geoJSON(data,{style:{color:"#000",weight:4}}).addTo(map);
  });
  fetch(buildingsURL).then(r=>r.json()).then(data=>{
    buildingLayer = L.geoJSON(data,{
      onEachFeature:(f,l)=>{ l.bindPopup("<b>Building:</b> "+(f.properties.name||"Unnamed")); }
    }).addTo(map);
  });
  fetch(pitchURL).then(r=>r.json()).then(data=>{
    pitchLayer = L.geoJSON(data,{
      style:{color:"orange"},
      onEachFeature:(f,l)=>{ l.bindPopup("<b>Pitch:</b> "+(f.properties.name||"Pitch")); }
    }).addTo(map);
  });
}

// ---------------- SEARCH DESTINATION ----------------
function searchFeature(){
  const q=document.getElementById("searchBox").value.toLowerCase();
  let found=null;

  [buildingLayer,pitchLayer].forEach(layer=>{
    if(!layer) return;
    layer.eachLayer(l=>{
      const name=l.feature.properties.name;
      if(name && name.toLowerCase().includes(q)) found=l;
    });
  });

  if(found){
    map.fitBounds(found.getBounds(),{maxZoom:18});
    found.openPopup();
    if(destinationMarker) map.removeLayer(destinationMarker);

    const flagIcon = L.icon({
      iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',
      iconSize:[30,30],
      iconAnchor:[15,30]
    });

    destinationMarker=L.marker(found.getBounds().getCenter(),{icon:flagIcon})
      .addTo(map)
      .bindPopup("Destination")
      .openPopup();

    drawRoute();
  }
}

// ---------------- USER LOCATION ----------------
function locateUser(){
  if(!navigator.geolocation) return alert("Geolocation not supported!");

  const blueIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });

  map.locate({enableHighAccuracy:true, watch:true});
  map.on("locationfound", e=>{
    if(userMarker) userMarker.setLatLng(e.latlng);
    else userMarker=L.marker(e.latlng,{icon:blueIcon}).addTo(map).bindPopup("You are here").openPopup();

    document.getElementById('latBox').textContent="Lat: "+e.latlng.lat.toFixed(6);
    document.getElementById('lngBox').textContent="Lng: "+e.latlng.lng.toFixed(6);

    if(destinationMarker) drawRoute();
  });
}

// ---------------- ROUTE ----------------
function drawRoute(){
  if(!userMarker || !destinationMarker) return;

  if(routeLine) map.removeLayer(routeLine);

  const from=userMarker.getLatLng();
  const to=destinationMarker.getLatLng();

  let inside=false;
  if(boundaryLayer){
    boundaryLayer.eachLayer(l=>{
      if(turf.booleanPointInPolygon(turf.point([from.lng, from.lat]), l.toGeoJSON())) inside=true;
    });
  }

  if(inside && roadsLayer){
    const fromPoint = turf.point([from.lng, from.lat]);
    const toPoint = turf.point([to.lng, to.lat]);
    const snappedFrom = turf.nearestPointOnLine(roadsLayer.toGeoJSON(), fromPoint);
    const snappedTo = turf.nearestPointOnLine(roadsLayer.toGeoJSON(), toPoint);

    routeLine = L.polyline([
      [snappedFrom.geometry.coordinates[1], snappedFrom.geometry.coordinates[0]],
      [snappedTo.geometry.coordinates[1], snappedTo.geometry.coordinates[0]]
    ], {color:'red', weight:3}).addTo(map);

  } else {
    routeLine = L.polyline([from, to], {color:'red', weight:3, dashArray:'5,5'}).addTo(map);
  }

  // Distance
  const dist=turf.distance(
    turf.point([from.lng,from.lat]),
    turf.point([to.lng,to.lat]), {units:'meters'}
  );
  document.getElementById('distBox').textContent="Distance: "+dist.toFixed(1)+" m";

  // Direction
  const bearing = turf.bearing(
    turf.point([from.lng, from.lat]),
    turf.point([to.lng, to.lat])
  );
  const directions = ["N","NE","E","SE","S","SW","W","NW"];
  const index = Math.round(((bearing + 360) % 360) / 45) % 8;
  document.getElementById('dirBox').textContent="Direction: "+directions[index];

  // Next turn placeholder
  document.getElementById('turnBox').textContent="Next: Straight";
}
</script>

<!-- SERVICE WORKER REGISTRATION -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log("Service Worker registered successfully"))
    .catch(err => console.log("Service Worker registration failed:", err));
}
</script>

</body>
</html>
